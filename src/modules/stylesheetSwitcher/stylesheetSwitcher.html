<div>
  <label for="{{id}}_select">{{label || ''}}</label>
  <select ref:selectElem id="{{id}}_select" on:change="setSelected(this.value)">
    {{#each stylesheets as sheet}}
    <option value="{{sheet.label}}">{{sheet.label}}</option>
    {{/each}}
  </select>
</div>

<script>
  // This is a test of the Svelte framework to evaluate how it can be integrated with other frameworks
  // like Angular and React.
  // It compiles to plain JS, which means it is a lot more portable than a framework-based component.
  // But code coverage with Istanbul is challenging at the moment.
  // Worst comes to worst, it should be simple to convert this to n Angular 1.x component.
  let ssMap = new Map();

  function persistSelectedStyleSheet(keyName, value) {
    window.sessionStorage.setItem(keyName, value);
  }

  function retrieveSelectedStyleSheet(keyName) {
    return window.sessionStorage.getItem(keyName);
  }

  export default {
    oncreate() {
      let persistedValue = retrieveSelectedStyleSheet(this.get('persistenceKeyName'));

      this.observe('stylesheets', (sheets) => {
        ssMap.clear();
        sheets.forEach(sheet => {
          ssMap.set(sheet.label, document.head.querySelector(`link[rel="stylesheet"][href*="${sheet.linkHrefContains}"]`))
        });

        if (persistedValue && ssMap.has(persistedValue)) {
          this.setSelected(persistedValue);
        } else if (ssMap.size > 0) {
          // Set selected value to first value in the list (no need to update UI)
          this.setSelected(ssMap.keys().next().value, false);
        }
      });
    },
    data() {
      let obj = {
        stylesheets: [],      // Element is an object: {label: <string>, linkHrefContains: <string>}
        label: 'Stylesheet:',
        id: 'sss_' + (new Date().getTime()),
        persistenceKeyName: '__stylesheetSwitcher'
      };

      return obj;
    },
    methods: {
      setSelected(selectedKey, updateUI = true) {
        ssMap.forEach((value, key) => value.disabled = (key !== selectedKey));
        persistSelectedStyleSheet(this.get('persistenceKeyName'), selectedKey);

        let selectElem = this.refs.selectElem;

        this.fire('selectionChange', {value: selectedKey});

        if (updateUI) {
          // Update the drop-down to match the initial value
          [...selectElem.options].forEach((option, index) => {
            if (option.value === selectedKey) {
              selectElem.selectedIndex = index;
            }
          });
        }
      },
      getSelected() {
        let selectElem = this.refs.selectElem;
        return selectElem.options[selectElem.selectedIndex].value;
      }
    }
  };
</script>
